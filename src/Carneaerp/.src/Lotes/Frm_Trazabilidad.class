' Gambas class file

Public Factura_Albaran As String


Public Sub Form_Open()

  Dim Sql As String
  
  Me.Title = "GESTION DE TRAZABILIDAD"
  
  sql = "select codigolote from lotes"
  Utilidades.Llenar_Combobox(sql, cmblotes, "codigolote")
  cmblotes.Index = -1
    
End

Public Sub BtnSalirTrazabilidad_Click()

  Me.Close

End

Public Sub BtnVisualizar_Click()
 Dim Lote As Form
 If ComprobarLote() Then
    Factura_Albaran = cmblotes.Text
    lote = New Frm_Visualiza_Lote_Trazabilidad 
    activar(lote, cmblotes.Text)
    cmblotes.Index = -1
  Endif
 
End


''*************************** Funciones privadas****************************
''
''**************************************************************************

'' Procedimiento para Generar mostrar en el Workspace el lote seleccionado <br>
'' Parametros:<br>
''    elform --> formulario abrir
Public Procedure activar(elform As Form, lote As String)

    Dim cont As Form
    Dim lAbierto As Boolean
    Dim Titulo As String
    Titulo = "Lote :" & lote
    For Each cont In wrktrazabilidad.windows  'buscamos si ya hay habierto un formulario con el mismo nombre del que se quiere abrir, o sea, si ya está abierto.
        'If cont.name = elform.Name And cont.text = elform.text Then
    
        If cont.title = Titulo Then
            lAbierto = True
            'Break
        Endif
    Next
    
    If lAbierto Then
        wrktrazabilidad.ActiveWindow = cont 'Si ya está  lo hacemos activo y eliminamos el que se quería abrir por ser un duplicidado
        elform.Delete
    Else
        wrktrazabilidad.Add(elform)  'lo añadimos al workspace
    Endif

End
'' comprobamos que se ha introducido un lote correcto
Private Function ComprobarLote() As Boolean
  
  Dim Validar As Boolean
  Dim Sql As String
  validar = True
  sql = "select codigolote from lotes where codigolote='" & cmblotes.Text & "'"
   If cmblotes.Text = "" Then
    Balloon.Error("Introduzca Lote para ver Trazabilidad", cmblotes)
    validar = False
    cmblotes.SetFocus
   Else If Not Utilidades.Comprobar_existe_dato(Sql) 
      Balloon.Error("Lote  no existe", cmblotes)
      Validar = False
      cmblotes.SetFocus
   Endif 
  Return validar
  
End
