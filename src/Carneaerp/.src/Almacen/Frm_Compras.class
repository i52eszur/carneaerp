' Gambas class file

Public Codigo_Stock_Para_Edicion As String
Public Kilos_Stock_Para_Edicion As String
Public Materia_Prima_Para_Edicion As String
Public Proveedor_Stock_Para_Edicion As String
Public Linea_Compras As Integer
Public Uso_Filtro As Boolean

Public Sub Form_Open()
  Me.Title = "GESTION DE COMPRAS"
 
  Configurar_Objetos_Compras()
End




''*************************** Conmfiguracion Botones ***********************
''
''**************************************************************************

Public Sub CmbProveedor_Click()
  Dim Sql As String
  Dim Codigo_Proveedor As String
  If CmbProveedor.Text = "" Then
    CmbMateriaPrima.Clear
 Else
    Codigo_Proveedor = Utilidades.Obtener_Campo_Tabla("select * from proveedor where razonsocial = '" & CmbProveedor.text & "'", "codigoproveedor")
    sql = "select nombre from materiaprima where codigomateriaprima in (select materiaprima from proveedormateriaprima where proveedor='" & Codigo_Proveedor & "') order by 1"
    Utilidades.Llenar_Combobox(sql, CmbMateriaPrima, "nombre")  
  Endif
End

Public Sub BtnAgregarCompra_Click()

  Dim Sql As String
  Dim Higiene As String
  Dim Carolep As String
  Dim Stock As String
  Dim Fecha_Recepcion As String
  Dim Fecha_Factura_Compra As String
  Dim Aux As String
  Dim Codigo_Proveedor As String
  Dim Codigo_Materia_Prima As String
  Dim Codigo_Maximo_Compra As String
  
  If Comprobar_Campos_Compras() Then
    Aux = DteFechaRecepcion.Value
    Fecha_Recepcion = utilidades.Fecha_Correcta(Aux)
    Aux = DteFFacturaCompra.Value
    Fecha_Factura_Compra = utilidades.Fecha_Correcta(Aux)
    If RdbHigieneAceptable.Value = True Then
      Higiene = "ACEPTABLE"
    Else
       higiene = "NO ACEPTABLE"
    Endif
    If RdbCarolepAceptable.Value = True Then
      Carolep = "ACEPTABLE"
    Else
       Carolep = "NO ACEPTABLE"
    Endif
    If ChkAgregarStock.Value = True Then
      Stock = "S"
    Else  
      Stock = "N"
    Endif
    sql = "select * from proveedor where razonsocial='" & CmbProveedor.Text & "'"
    Codigo_Proveedor = utilidades.Obtener_Campo_Tabla(sql, "codigoproveedor")
    sql = "select * from materiaprima where nombre='" & CmbMateriaPrima.Text & "'"
    Codigo_Materia_Prima = utilidades.Obtener_Campo_Tabla(sql, "codigomateriaprima")
    'Insertamos en la tabla Vendedor
    sql = "insert into compras (fecharecepcion,fechafacturacompra,cantidad,lotecompra,nfacturacompra,higiene,carolep,precio,firma,observaciones,transporte,stock,proveedor,materiaprima)" &
    " values('" & Fecha_Recepcion & "','" & Fecha_Factura_Compra & "'," & CFloat(VlbCantidad.Text) & ",'" & UCase(TxtNLoteCompra.Text) & "','" & UCase(TxtNFacturaCompra.text) & "','" & Higiene &
    "','" & Carolep & "'," & CFloat(VlbPrecio.Text) & ",'" & TxtFirma.Text & "','" & TxtObservaciones.text & "'," & CInt(VlbTransporte.Text) & ",'" & Stock & "','" & Codigo_Proveedor &
    "','" & Codigo_Materia_Prima & "')"
    utilidades.In_Act_Bor(sql)   
    ' Añadimos a Stock 
    If ChkAgregarStock.Value = True Then
      
    Codigo_Maximo_Compra = utilidades.Valor_Maximo("select codigocompra from compras order by codigocompra", "codigocompra")
    'Codigo_Maximo_Compra = CStr(Val(Codigo_Maximo_Compra) + 1)
      sql = "insert into stock (codigostock,materiaprima,cantidad,lotecompra,proveedor,nfacturacompra,ffacturacompra,precio,usado)" &
    " values('" & Codigo_Maximo_Compra & "','" & Codigo_Materia_Prima & "'," & CFloat(VlbCantidad.Text) & ",'" & UCase(TxtNLoteCompra.Text) & "','" & Codigo_Proveedor & "','" & UCase(TxtNFacturaCompra.text) &
    "','" & Fecha_Factura_Compra & "'," & CFloat(VlbPrecio.Text) & ",'N')"
    utilidades.In_Act_Bor(sql)   
    Endif
    
    Borrar_Campos_Compras()
   sql = "select C.codigocompra,C.fecharecepcion,C.fechafacturacompra,P.razonsocial, M.nombre,C.cantidad,C.Lotecompra,C.nfacturacompra,C.higiene,C.carolep,C.precio,C.firma,C.observaciones,C.transporte," &
   "C.stock From compras C, proveedor P,materiaprima M where C.proveedor=P.codigoproveedor and C.materiaprima=M.codigomateriaprima"
   Llenar_Datagrid_Compras(sql)
  Endif
  

End

Public Sub BtnBorrarCompra_Click()
  Dim Sql As String
  Dim Numero_fila As Integer
  Dim Respuesta As Integer
  Dim Texto As String
  Dim Producto As String
  Dim Proveedor As String
  Dim Lote_Compra As String
  Dim Numero_Factura_Compra As String
  Dim Stock_Usado As String
  Dim Stock_Kilos As String
  Dim Codigo_Proveedor As String
  Dim Codigo_Materia_Prima As String
  Dim Pasado_Stock As Boolean
  Dim Id_Stock As String
  Dim Codigo_Compra As String
  Pasado_Stock = False
  
  If GridCompras.Rows.Selection.Count > 0 Then
    Numero_fila = GridCompras.Rows.Selection[0]
    Codigo_Compra = GridCompras[Numero_fila, 0].Text
    Producto = GridCompras[Numero_fila, 4].Text
    Proveedor = GridCompras[Numero_fila, 3].Text
    Lote_Compra = GridCompras[Numero_fila, 6].Text
    Numero_Factura_Compra = GridCompras[Numero_fila, 7].Text
    Codigo_Proveedor = Utilidades.Obtener_Campo_Tabla("select * from proveedor where razonsocial = '" & Proveedor & "'", "codigoproveedor")
    Codigo_Materia_Prima = Utilidades.Obtener_Campo_Tabla("select * from materiaprima where nombre='" & Producto & "'", "codigomateriaprima")
    sql = "select * from stock where materiaprima='" & Codigo_Materia_Prima & "' and proveedor='" & Codigo_Proveedor & "' and lotecompra='" &
    Lote_Compra & "' and nfacturacompra='" & Numero_Factura_Compra & "'"
    Texto = "Desea Borrar la compra con Producto:<b> " & Producto & " </b>,Proveedor:<b>" & Proveedor &
    "</b> ,Lote Compra:<b> " & Lote_Compra & " </b>,Nº Factura Compra:<b> " & Numero_Factura_Compra & " </b><br>"
    If Utilidades.Tabla_Vacia(sql) > 0 Then
      Pasado_Stock = True
      Stock_Usado = Utilidades.Obtener_Campo_Tabla(sql, "usado")
      Stock_Kilos = Utilidades.Obtener_Campo_Tabla(sql, "cantidad")
      Texto = Texto & "La compra esta en Stock y "
      If Stock_Usado = "N" Then
        Texto = Texto & "<b>NO</b> ha sigo usada quedando <b>" & Stock_Kilos & "</b> Kilos en Stock"
        Else
          Texto = Texto & "<b>SI</b> ha sigo usada quedando <b>" & Stock_Kilos & "</b> Kilos en Stock"
      Endif
      Respuesta = Message.Delete(Texto, "Compras", "Compras y Stock", "Salir")
    Else
      Texto = Texto & "<b>La compra aun no se ha pasado a stock.</b>"
      Respuesta = Message.Delete(Texto, "Si", "No")
    End If 
    
   
    If respuesta = 1 Then
      ' Tabla Compras
      sql = "delete from compras where codigocompra=" & Codigo_Compra & "" 
      Utilidades.In_Act_Bor(Sql)
      sql = "select C.codigocompra,C.fecharecepcion,C.fechafacturacompra,P.razonsocial, M.nombre,C.cantidad,C.Lotecompra,C.nfacturacompra,C.higiene,C.carolep,C.precio,C.firma,C.observaciones,C.transporte," &
      "C.stock From compras C, proveedor P,materiaprima M where C.proveedor=P.codigoproveedor and C.materiaprima=M.codigomateriaprima"
      Llenar_Datagrid_Compras(sql)
     Else If respuesta = 2 And Pasado_Stock
      ' Tabla Stock 
      sql = "delete from compras where codigocompra=" & Codigo_Compra & "" 
      Utilidades.In_Act_Bor(Sql)
      sql = "select * from stock where materiaprima='" & Codigo_Materia_Prima & "' and proveedor='" & Codigo_Proveedor & "' and lotecompra='" &
      Lote_Compra & "' and nfacturacompra='" & Numero_Factura_Compra & "'"
      Id_Stock = utilidades.Obtener_Campo_Tabla(sql, "codigostock")
      sql = "delete from stock where codigostock=" & Id_Stock & "" 
      Utilidades.In_Act_Bor(Sql)
      sql = "select C.codigocompra,C.fecharecepcion,C.fechafacturacompra,P.razonsocial, M.nombre,C.cantidad,C.Lotecompra,C.nfacturacompra,C.higiene,C.carolep,C.precio,C.firma,C.observaciones,C.transporte," &
      "C.stock From compras C, proveedor P,materiaprima M where C.proveedor=P.codigoproveedor and C.materiaprima=M.codigomateriaprima"
      Llenar_Datagrid_Compras(sql)
    Endif
    
   Endif
End

Public Sub BtnEditarCompra_Click()
  
  Dim Sql As String
  Dim Numero_fila As Integer 
  Dim Respuesta As Integer
  Dim Texto As String
  Dim Dia As String
  Dim Mes As String
  Dim Ano As String
  Dim Codigo_Compra As String
  Dim Higiene As String
  Dim Carolep As String
  Dim Stock As String
  Dim Fecha_Recepcion As String
  Dim Fecha_Factura_Compra As String
  Dim Aux As String
  Dim Codigo_Proveedor As String
  Dim Codigo_Materia_Prima As String
  Dim Usado_stock As String
  Dim Pasado_Stock As String
  Dim Codigo_Maximo_Compra As String
  
  If BtnEditarCompra.text = "EDITAR" And GridCompras.Rows.Selection.Count > 0 Then
    Numero_fila = GridCompras.Rows.Selection[0]
    Codigo_Compra = GridCompras[Numero_fila, 0].Text
    Dia = Mid(GridCompras[Numero_fila, 1].Text, 1, 2)
    Mes = Mid(GridCompras[Numero_fila, 1].Text, 4, 2)
    Ano = Mid(GridCompras[Numero_fila, 1].Text, 7, 4)
    DteFechaRecepcion.Value = Date(ano, mes, dia)
    Dia = Mid(GridCompras[Numero_fila, 2].Text, 1, 2)
    Mes = Mid(GridCompras[Numero_fila, 2].Text, 4, 2)
    Ano = Mid(GridCompras[Numero_fila, 2].Text, 7, 4)
    DteFFacturaCompra.Value = Date(ano, mes, dia)
    CmbProveedor.Text = GridCompras[Numero_fila, 3].Text
    CmbProveedor_Click()
    CmbMateriaPrima.Text = GridCompras[Numero_fila, 4].Text
    VlbCantidad.Value = GridCompras[Numero_fila, 5].Text
    TxtNLoteCompra.text = GridCompras[Numero_fila, 6].Text
    TxtNFacturaCompra.Text = GridCompras[Numero_fila, 7].Text
    If GridCompras[Numero_fila, 8].Text = "ACEPTABLE" Then
      RdbHigieneAceptable.Value = True
    Else
      RdbHigieneNoAceptable.value = True
    Endif
    If GridCompras[Numero_fila, 9].Text = "ACEPTABLE" Then
      RdbCarolepAceptable.Value = True
    Else
      RdbCarolepNoAceptable.value = True
    Endif
    VlbPrecio.Value = GridCompras[Numero_fila, 10].Text
    TxtFirma.text = GridCompras[Numero_fila, 11].Text
    TxtObservaciones.Text = GridCompras[Numero_fila, 12].Text
    VlbTransporte.Value = GridCompras[Numero_fila, 13].Text
    If GridCompras[Numero_fila, 14].Text = "S" Then
      ChkAgregarStock.Value = True
      Pasado_Stock = "S"
    Else
      ChkAgregarStock.Value = False
      Pasado_Stock = "N"
    Endif

    sql = "select * from proveedor where razonsocial='" & CmbProveedor.Text & "'"
    Codigo_Proveedor = utilidades.Obtener_Campo_Tabla(sql, "codigoproveedor")
    sql = "select * from materiaprima where nombre='" & CmbMateriaPrima.Text & "'"
    Codigo_Materia_Prima = utilidades.Obtener_Campo_Tabla(sql, "codigomateriaprima")
    sql = "select * from stock where materiaprima='" & Codigo_Materia_Prima & "' and proveedor='" & Codigo_Proveedor & "' and lotecompra='" &
    UCase(TxtNLoteCompra.Text) & "' and nfacturacompra='" & TxtNFacturaCompra.text & "'"
    If Pasado_Stock = "S" Then
      Usado_stock = utilidades.Obtener_Campo_Tabla(sql, "usado")
      Codigo_Stock_Para_Edicion = utilidades.Obtener_Campo_Tabla(sql, "codigostock")
      Kilos_Stock_Para_Edicion = utilidades.Obtener_Campo_Tabla(sql, "cantidad")
      Materia_Prima_Para_Edicion = utilidades.Obtener_Campo_Tabla(sql, "materiaprima")
      Proveedor_Stock_Para_Edicion = utilidades.Obtener_Campo_Tabla(sql, "proveedor")
      If Usado_stock = "S" Then
        TxtlerrorCompras.Visible = True
        TxtlerrorCompras.Text = "La compra ha sido usada en Stock."
      Endif
    End If
     
    BtnBorrarCompra.Enabled = False
    BtnAgregarCompra.Enabled = False
    FrameFiltrar.Enabled = False
    GridCompras.Enabled = False
    BtnEditarCompra.text = "ACTUALIZAR"
  Else
    If Comprobar_Campos_Compras() Then
      Aux = DteFechaRecepcion.Value
      Fecha_Recepcion = utilidades.Fecha_Correcta(Aux)
      Aux = DteFFacturaCompra.Value
      Fecha_Factura_Compra = utilidades.Fecha_Correcta(Aux)
      Codigo_Compra = GridCompras[Numero_fila, 0].Text
      If RdbHigieneAceptable.Value = True Then
        Higiene = "ACEPTABLE"
      Else
         higiene = "NO ACEPTABLE"
      Endif
      If RdbCarolepAceptable.Value = True Then
        Carolep = "ACEPTABLE"
      Else
         Carolep = "NO ACEPTABLE"
      Endif
      If ChkAgregarStock.Value = True Then
        Stock = "S"
      Else  
        Stock = "N"
      Endif
      sql = "select * from proveedor where razonsocial='" & CmbProveedor.Text & "'"
      Codigo_Proveedor = utilidades.Obtener_Campo_Tabla(sql, "codigoproveedor")
      sql = "select * from materiaprima where nombre='" & CmbMateriaPrima.Text & "'"
      Codigo_Materia_Prima = utilidades.Obtener_Campo_Tabla(sql, "codigomateriaprima")
    'Actualizamos en la tabla Compras
      sql = "update compras set fecharecepcion='" & Fecha_Recepcion & "',fechafacturacompra='" & Fecha_Factura_Compra & "',cantidad=" & CFloat(VlbCantidad.Text) &
      ",lotecompra='" & UCase(TxtNLoteCompra.Text) & "',nfacturacompra='" & UCase(TxtNFacturaCompra.text) & "',higiene='" & higiene & "',carolep='" & carolep & "',precio=" & CFloat(VlbPrecio.Text) &
      ",firma='" & TxtFirma.Text & "',observaciones='" & TxtObservaciones.text & "',transporte=" & CInt(VlbTransporte.Text) & ",stock='" & Stock & "',proveedor='" &
      Codigo_Proveedor & "',materiaprima='" & Codigo_Materia_Prima & "' where codigocompra=" & Codigo_Compra
      Print sql
       utilidades.In_Act_Bor(sql)   
      ' Añadimos a Stock si hemos marcado Y no esta aun en stock
    sql = "select * from stock where materiaprima='" & Codigo_Materia_Prima & "' and proveedor='" & Codigo_Proveedor & "' and lotecompra='" &
    TxtNLoteCompra.Text & "' and nfacturacompra='" & TxtNFacturaCompra.text & "'"
      If Not utilidades.Comprobar_existe_dato(sql) Then
        ' Si no existe en Stock pero hemos pulsado para añadir.
        If ChkAgregarStock.Value = True Then
          Codigo_Maximo_Compra = utilidades.Valor_Maximo("select codigocompra from compras order by codigocompra", "codigocompra")
         ' Codigo_Maximo_Compra = CStr(Val(Codigo_Maximo_Compra) + 1)
          sql = "insert into stock (codigostock,materiaprima,cantidad,lotecompra,proveedor,nfacturacompra,ffacturacompra,precio,usado)" &
          " values('" & Codigo_Maximo_Compra & "','" & Codigo_Materia_Prima & "'," & CFloat(VlbCantidad.Text) & ",'" & UCase(TxtNLoteCompra.Text) & "','" & Codigo_Proveedor & "','" & UCase(TxtNFacturaCompra.text) &
          "','" & Fecha_Factura_Compra & "'," & CFloat(VlbPrecio.Text) & ",'N')"

          utilidades.In_Act_Bor(sql)   
        Endif
      Else
        ' Si ya estaba en Stock.
        If ChkAgregarStock.Value = False Then
          ' Lo queremos quitar del Stock
          Texto = "La compra esta en Stock Materia Prima: <b>" & Materia_Prima_Para_Edicion & " </b>con la siguiente cantidad de Kilos: <b> " & Kilos_Stock_Para_Edicion & " </b> Proveedor: <b>" &
          Proveedor_Stock_Para_Edicion & "</b> <br> ¿Desea Borrarla de Stock y Agregar la nueva?"
          Respuesta = Message.Delete(Texto, "Si", "No")
          If respuesta = 1 Then
            sql = "delete from stock where codigostock=" & Codigo_Stock_Para_Edicion & "" 
            utilidades.In_Act_Bor(sql) 
            Codigo_Maximo_Compra = utilidades.Valor_Maximo("select codigocompra from compras order by codigocompra", "codigocompra")
            'Codigo_Maximo_Compra = CStr(Val(Codigo_Maximo_Compra) + 1)
            sql = "insert into stock (codigostock,materiaprima,cantidad,lotecompra,proveedor,nfacturacompra,ffacturacompra,precio,usado)" &
            " values('" & Codigo_Maximo_Compra & "','" & Codigo_Materia_Prima & "'," & CFloat(VlbCantidad.Text) & ",'" & UCase(TxtNLoteCompra.Text) & "','" & Codigo_Proveedor & "','" & UCase(TxtNFacturaCompra.text) &
            "','" & Fecha_Factura_Compra & "'," & CFloat(VlbPrecio.Text) & ",'N')"

          utilidades.In_Act_Bor(sql)     
          Endif
        Endif
      Endif
      sql = "select C.codigocompra,C.fecharecepcion,C.fechafacturacompra,P.razonsocial, M.nombre,C.cantidad,C.Lotecompra,C.nfacturacompra,C.higiene,C.carolep,C.precio,C.firma,C.observaciones,C.transporte," &
      "C.stock From compras C, proveedor P,materiaprima M where C.proveedor=P.codigoproveedor and C.materiaprima=M.codigomateriaprima"
      Llenar_Datagrid_Compras(sql)
      BtnBorrarCompra.Enabled = True
      BtnAgregarCompra.Enabled = True
      FrameFiltrar.Enabled = True
      GridCompras.Enabled = True
      Borrar_Campos_Compras()
      BtnEditarCompra.text = "EDITAR"
      TxtlerrorCompras.Visible = False
      TxtlerrorCompras.text = ""
      Borrar_Campos_Compras()
  
     Endif
    
  Endif
  
End

Public Sub BtnSalirCompras_Click()

  Me.Close

End

Public Sub ChkVariasCompras_Click()

  If ChkVariasCompras.value = True Then
    If Comprobar_Campos_Varias_Compras() Then
      DteFechaRecepcion.Enabled = False
      DteFFacturaCompra.Enabled = False
      TxtNFacturaCompra.Enabled = False
      TxtNLoteCompra.Enabled = False
      CmbProveedor.Enabled = False
    Else
      ChkVariasCompras.Value = False

    Endif
  Else
    CmbProveedor.Enabled = True
    TxtNFacturaCompra.Enabled = True
    TxtNLoteCompra.Enabled = True
    DteFechaRecepcion.Enabled = True
    DteFFacturaCompra.Enabled = True
  Endif
End




Public Sub BtnComprasInicio_Click()

  If GridCompras.Rows.Count > 0 Then
      GridCompras.Rows.UnSelectAll
      Linea_Compras = 0
      GridCompras.Rows.Select(Linea_Compras, 1) 
  Endif

End

Public Sub BtnComprasAnterior_Click()

  If GridCompras.Rows.Count > 0 Then
    If Linea_Compras = 0 Then
      GridCompras.Rows.Select(Linea_Compras, 1)
     Else  
       GridCompras.Rows.UnSelectAll
       Linea_Compras = Linea_Compras - 1
       GridCompras.Rows.Select(Linea_Compras, 1)
    Endif
  Endif  

End

Public Sub BtnComprasSiguiente_Click()

   If GridCompras.Rows.Count > 0 Then
    If Linea_Compras = GridCompras.Rows.Count - 1 Then
      GridCompras.Rows.Select(Linea_Compras, 1)
     Else  
       GridCompras.Rows.UnSelectAll
       Linea_Compras = Linea_Compras + 1
       GridCompras.Rows.Select(Linea_Compras, 1)
    Endif
  Endif

End

Public Sub BtnComprasFin_Click()

  If GridCompras.Rows.Count > 0 Then
      GridCompras.Rows.UnSelectAll
      Linea_Compras = GridCompras.Rows.Count - 1
      GridCompras.Rows.Select(Linea_Compras, 1)
      
  Endif

End
Public Sub GridCompras_DblClick()

  Dim sql As String
  Dim Columna_Seleccionada As Integer
  If Not Uso_Filtro Then
   Columna_Seleccionada = GridCompras.Column
   Select Columna_Seleccionada
     Case 0
       sql = "select C.codigocompra,C.fecharecepcion,C.fechafacturacompra,P.razonsocial, M.nombre,C.cantidad,C.Lotecompra,C.nfacturacompra,C.higiene,C.carolep,C.precio,C.firma,C.observaciones,C.transporte," &
      "C.stock From compras C, proveedor P,materiaprima M where C.proveedor=P.codigoproveedor and C.materiaprima=M.codigomateriaprima order by 1"
     Case 1
       sql = "select C.codigocompra,C.fecharecepcion,C.fechafacturacompra,P.razonsocial, M.nombre,C.cantidad,C.Lotecompra,C.nfacturacompra,C.higiene,C.carolep,C.precio,C.firma,C.observaciones,C.transporte," &
      "C.stock From compras C, proveedor P,materiaprima M where C.proveedor=P.codigoproveedor and C.materiaprima=M.codigomateriaprima order by 2"
     Case 2 
       sql = "select C.codigocompra,C.fecharecepcion,C.fechafacturacompra,P.razonsocial, M.nombre,C.cantidad,C.Lotecompra,C.nfacturacompra,C.higiene,C.carolep,C.precio,C.firma,C.observaciones,C.transporte," &
      "C.stock From compras C, proveedor P,materiaprima M where C.proveedor=P.codigoproveedor and C.materiaprima=M.codigomateriaprima order by 3"
      Case 3 
       sql = "select C.codigocompra,C.fecharecepcion,C.fechafacturacompra,P.razonsocial, M.nombre,C.cantidad,C.Lotecompra,C.nfacturacompra,C.higiene,C.carolep,C.precio,C.firma,C.observaciones,C.transporte," &
      "C.stock From compras C, proveedor P,materiaprima M where C.proveedor=P.codigoproveedor and C.materiaprima=M.codigomateriaprima order by 4"
      Case 4 
       sql = "select C.codigocompra,C.fecharecepcion,C.fechafacturacompra,P.razonsocial, M.nombre,C.cantidad,C.Lotecompra,C.nfacturacompra,C.higiene,C.carolep,C.precio,C.firma,C.observaciones,C.transporte," &
      "C.stock From compras C, proveedor P,materiaprima M where C.proveedor=P.codigoproveedor and C.materiaprima=M.codigomateriaprima order by 5"
      Case 5 
       sql = "select C.codigocompra,C.fecharecepcion,C.fechafacturacompra,P.razonsocial, M.nombre,C.cantidad,C.Lotecompra,C.nfacturacompra,C.higiene,C.carolep,C.precio,C.firma,C.observaciones,C.transporte," &
      "C.stock From compras C, proveedor P,materiaprima M where C.proveedor=P.codigoproveedor and C.materiaprima=M.codigomateriaprima order by 6"
      Case 6 
       sql = "select C.codigocompra,C.fecharecepcion,C.fechafacturacompra,P.razonsocial, M.nombre,C.cantidad,C.Lotecompra,C.nfacturacompra,C.higiene,C.carolep,C.precio,C.firma,C.observaciones,C.transporte," &
      "C.stock From compras C, proveedor P,materiaprima M where C.proveedor=P.codigoproveedor and C.materiaprima=M.codigomateriaprima order by 7"
      Case 7 
       sql = "select C.codigocompra,C.fecharecepcion,C.fechafacturacompra,P.razonsocial, M.nombre,C.cantidad,C.Lotecompra,C.nfacturacompra,C.higiene,C.carolep,C.precio,C.firma,C.observaciones,C.transporte," &
      "C.stock From compras C, proveedor P,materiaprima M where C.proveedor=P.codigoproveedor and C.materiaprima=M.codigomateriaprima order by 8"
      Case 8
       sql = "select C.codigocompra,C.fecharecepcion,C.fechafacturacompra,P.razonsocial, M.nombre,C.cantidad,C.Lotecompra,C.nfacturacompra,C.higiene,C.carolep,C.precio,C.firma,C.observaciones,C.transporte," &
      "C.stock From compras C, proveedor P,materiaprima M where C.proveedor=P.codigoproveedor and C.materiaprima=M.codigomateriaprima order by 9"
      Case 9 
       sql = "select C.codigocompra,C.fecharecepcion,C.fechafacturacompra,P.razonsocial, M.nombre,C.cantidad,C.Lotecompra,C.nfacturacompra,C.higiene,C.carolep,C.precio,C.firma,C.observaciones,C.transporte," &
      "C.stock From compras C, proveedor P,materiaprima M where C.proveedor=P.codigoproveedor and C.materiaprima=M.codigomateriaprima order by 10"
      Case 10 
       sql = "select C.codigocompra,C.fecharecepcion,C.fechafacturacompra,P.razonsocial, M.nombre,C.cantidad,C.Lotecompra,C.nfacturacompra,C.higiene,C.carolep,C.precio,C.firma,C.observaciones,C.transporte," &
      "C.stock From compras C, proveedor P,materiaprima M where C.proveedor=P.codigoproveedor and C.materiaprima=M.codigomateriaprima order by 11"
      Case 11 
       sql = "select C.codigocompra,C.fecharecepcion,C.fechafacturacompra,P.razonsocial, M.nombre,C.cantidad,C.Lotecompra,C.nfacturacompra,C.higiene,C.carolep,C.precio,C.firma,C.observaciones,C.transporte," &
      "C.stock From compras C, proveedor P,materiaprima M where C.proveedor=P.codigoproveedor and C.materiaprima=M.codigomateriaprima order by 12"
      Case 12 
       sql = "select C.codigocompra,C.fecharecepcion,C.fechafacturacompra,P.razonsocial, M.nombre,C.cantidad,C.Lotecompra,C.nfacturacompra,C.higiene,C.carolep,C.precio,C.firma,C.observaciones,C.transporte," &
      "C.stock From compras C, proveedor P,materiaprima M where C.proveedor=P.codigoproveedor and C.materiaprima=M.codigomateriaprima order by 13"
      Case 13 
       sql = "select C.codigocompra,C.fecharecepcion,C.fechafacturacompra,P.razonsocial, M.nombre,C.cantidad,C.Lotecompra,C.nfacturacompra,C.higiene,C.carolep,C.precio,C.firma,C.observaciones,C.transporte," &
      "C.stock From compras C, proveedor P,materiaprima M where C.proveedor=P.codigoproveedor and C.materiaprima=M.codigomateriaprima order by 14"
      Case 14 
       sql = "select C.codigocompra,C.fecharecepcion,C.fechafacturacompra,P.razonsocial, M.nombre,C.cantidad,C.Lotecompra,C.nfacturacompra,C.higiene,C.carolep,C.precio,C.firma,C.observaciones,C.transporte," &
      "C.stock From compras C, proveedor P,materiaprima M where C.proveedor=P.codigoproveedor and C.materiaprima=M.codigomateriaprima order by 15"
   End Select
   Llenar_Datagrid_Compras(sql)
  End If

End




Public Sub TxtNFacturaCompra_KeyRelease()

  If Key.Code = Key.Return Or Key.Code = Key.Enter Then
    TxtNLoteCompra.SetFocus
  Endif

End

Public Sub TxtNLoteCompra_KeyRelease()

  If Key.Code = Key.Return Or Key.Code = Key.Enter Then
    VlbCantidad.SetFocus
  Endif

End

Public Sub VlbCantidad_KeyRelease()

  If Key.Code = Key.Return Or Key.Code = Key.Enter Then
    VlbPrecio.SetFocus
  Endif

End

Public Sub VlbPrecio_KeyRelease()

  If Key.Code = Key.Return Or Key.Code = Key.Enter Then
    VlbTransporte.SetFocus
  Endif

End

Public Sub VlbTransporte_KeyRelease()

  If Key.Code = Key.Return Or Key.Code = Key.Enter Then
    TxtFirma.SetFocus
  Endif

End

Public Sub TxtFirma_KeyRelease()

  If Key.Code = Key.Return Or Key.Code = Key.Enter Then
    TxtObservaciones.SetFocus
  Endif

End
''*************************** Fin Conmfiguracion Botones *******************
''
''**************************************************************************



''*************************** FILTROS **************************************
''
''**************************************************************************


Public Sub BtnFiltrar_Click()
  Dim Validar As Boolean
  Validar = True
  Uso_Filtro = True
  If ChkFechaCompra.value = False And ChkFechaRecepcion.value = False And ChkMateriaPrima.Value = False And ChkProveedor.value = False And ChkPasadoAStock.value = False Then
    validar = False
    Balloon.Error("Debe elegir un filtro.", PanelFiltrar)
  Else If ChkProveedor.value = True And CmbFProveedor.Text = ""
    validar = False
    Balloon.Error("Si activa el filtro de los Proveedores debe seleccionar el Proveedor para filtrar.", CmbFProveedor)
  Else If ChkMateriaPrima.value = True And CmbfMateriaPrima.Text = ""
    validar = False
    Balloon.Error("Si activa el filtro de Materia Prima debe seleccionar la Materia Prima para filtrar.", CmbfMateriaPrima)
  Endif
  If validar Then
    Ejecutar_Filtros()  
  Endif
  
End
Public Sub BtnQuitarFiltro_Click()
  Uso_Filtro = False
  Quitar_Filtros()

End

Public Sub ChkFechaRecepcion_Click()

  If ChkFechaRecepcion.value = True Then
    PanelFRecepcion.Enabled = True
  Else
    PanelFRecepcion.Enabled = False
  Endif

End

Public Sub ChkFechaCompra_Click()
  
  If ChkFechaCompra.value = True Then
    PanelFCompra.Enabled = True
    
  Else
    PanelFCompra.Enabled = False
  Endif
  
End

Public Sub ChkProveedor_Click()

  If ChkProveedor.value = True Then
    PanelProveedor.Enabled = True   
  Else
    PanelProveedor.Enabled = True
  Endif

End

Public Sub ChkMateriaPrima_Click()

  If ChkMateriaPrima.Value = True Then
    PanelMatreriaprima.Enabled = True
    Else
      PanelMatreriaprima.Enabled = False
  Endif

End

Public Sub ChkPasadoAStock_Click()

  If ChkPasadoAStock.Value = True Then
    PanelStock.Enabled = True
    Else
      PanelStock.Enabled = False
  Endif

End



''*************************** FIN FILTROS *********************************+
''
''**************************************************************************




''*************************** Funciones privadas****************************
''
''**************************************************************************



'' Para quitar los filtros
Private Sub Quitar_Filtros()
  Dim Sql As String
   ChkFechaCompra.value = False
    ChkFechaRecepcion.value = False
    ChkMateriaPrima.value = False
    ChkProveedor.value = False
    ChkPasadoAStock.value = False
    CmbFMateriaPrima.Text = ""
    CmbFProveedor.text = ""
    PanelFRecepcion.Enabled = False
    PanelFCompra.Enabled = False
    PanelProveedor.Enabled = False
    PanelMatreriaprima.Enabled = False
    PanelStock.Enabled = False
    sql = "select C.codigocompra,C.fecharecepcion,C.fechafacturacompra,P.razonsocial, M.nombre,C.cantidad,C.Lotecompra,C.nfacturacompra,C.higiene,C.carolep,C.precio,C.firma,C.observaciones,C.transporte," &
    "C.stock From compras C, proveedor P,materiaprima M where C.proveedor=P.codigoproveedor and C.materiaprima=M.codigomateriaprima"
    Llenar_Datagrid_Compras(sql)
  
End

'' Ejecutamos los filtros cuando se han configurado Correctamente.
Private Sub Ejecutar_Filtros()
  
  Dim Sql As String
  
  
    sql = "select C.codigocompra,C.fecharecepcion,C.fechafacturacompra,P.razonsocial, M.nombre,C.cantidad,C.Lotecompra,C.nfacturacompra,C.higiene,C.carolep,C.precio,C.firma,C.observaciones,C.transporte," &
    "C.stock From compras C, proveedor P,materiaprima M where C.proveedor=P.codigoproveedor and C.materiaprima=M.codigomateriaprima"
    ' Seleccion del filtro Fecha Recepcion
    If ChkFechaRecepcion.value = True Then
      If DteFIRecepcion.Value = DteFFRecepcion.value Then
        sql &= " and C.fecharecepcion='" & Utilidades.Fecha_Correcta(DteFIRecepcion.value) & "'"
      Else
        sql &= " and C.fecharecepcion between '" & utilidades.Fecha_Correcta(DteFIRecepcion.value) & "' and '" & utilidades.Fecha_Correcta(DteFFRecepcion.value) & "'"
      Endif
    Endif
   ' Seleccion del filtro Fecha Compra
    If ChkFechaCompra.value = True Then
      If DteFICompra.Value = DteFFCompra.value Then
        sql &= " and C.fechafacturacompra='" & utilidades.Fecha_Correcta(DteFICompra.value) & "'"
      Else
        sql &= " and C.fechafacturacompra between '" & utilidades.Fecha_Correcta(DteFICompra.value) & "' and '" & utilidades.Fecha_Correcta(DteFFCompra.value) & "'"
      Endif
    Endif
    ' Seleccion del filtro Proveedor
    If ChkProveedor.value = True Then
      sql &= " and P.razonsocial='" & CmbFProveedor.text & "'"
    Endif
    ' Seleccion del filtro Materia Prima
    If ChkMateriaPrima.value = True Then
      sql &= " and M.nombre='" & CmbfMateriaPrima.text & "'"
    Endif
    ' Seleccion del filtro Stock
    If ChkPasadoAStock.value = True Then
      If RdbEnStock.value = True
        sql &= " and C.stock='S'"
      Else
        sql &= " and C.stock='N'"
      Endif  
    Endif

  Llenar_Datagrid_Compras(sql)
  
End


'' Configuracion del Grid Compras<br>

Private Sub Configurar_Grid_Compras()
  Dim Sql As String
  
  GridCompras.Columns.Count = 15
  GridCompras.Header = GridCompras.Both
  GridCompras.Columns[0].Title = "Codigo"
  GridCompras.Columns[1].Title = "Fecha Recepcion"
  GridCompras.Columns[2].Title = "Fecha F. Compra"
  GridCompras.Columns[3].Title = "Proveedor"
  GridCompras.Columns[4].Title = "Materia Prima"
  GridCompras.Columns[5].Title = "Cantidad"
  GridCompras.Columns[6].Title = "Lote Compra"
  GridCompras.Columns[7].Title = "N. F. Compra"
  GridCompras.Columns[8].Title = "Higiene"
  GridCompras.Columns[9].Title = "C. O. Leptidos"
  GridCompras.Columns[10].Title = "Precio"
  GridCompras.Columns[11].Title = "Firma"
  GridCompras.Columns[12].Title = "Observaciones"
  GridCompras.Columns[13].Title = "Transporte"
  GridCompras.Columns[14].Title = "Stock"
  
  GridCompras.Columns[0].Width = 90
  GridCompras.Columns[1].Width = 150
  GridCompras.Columns[2].Width = 150
  GridCompras.Columns[3].Width = 200  
  GridCompras.Columns[4].Width = 150  
  GridCompras.Columns[5].Width = 100  
  GridCompras.Columns[6].Width = 150
  GridCompras.Columns[7].Width = 150  
  GridCompras.Columns[8].Width = 90  
  GridCompras.Columns[9].Width = 120  
  GridCompras.Columns[10].Width = 100  
  GridCompras.Columns[11].Width = 150  
  GridCompras.Columns[12].Width = 150  
  GridCompras.Columns[13].Width = 150
  GridCompras.Columns[14].Width = 90
    sql = "select C.codigocompra,C.fecharecepcion,C.fechafacturacompra,P.razonsocial, M.nombre,C.cantidad,C.Lotecompra,C.nfacturacompra,C.higiene,C.carolep,C.precio,C.firma,C.observaciones,C.transporte," &
  "C.stock From compras C, proveedor P,materiaprima M where C.proveedor=P.codigoproveedor and C.materiaprima=M.codigomateriaprima"
  Llenar_Datagrid_Compras(sql)
  
End
'' Llenamos DataGrid Lote <br>
'' Parametros:<br>
''    Sql --> Sentencia para cargar datos en el Dataset
Private Sub Llenar_Datagrid_Compras(sql As String)
  Dim Result_Trabajo As Result
  Dim Numero_fila As Integer
  Numero_fila = GridCompras.Rows.Count
  If GridCompras.Rows.Count > 0 Then
    GridCompras.Rows.Remove(0, Numero_fila)  
  Endif  
  FMain.Conexion_Base_Datos.Close
  FMain.Conexion_Base_Datos.Open
  Result_Trabajo = FMain.Conexion_Base_Datos.Exec(Sql)
  Result_Trabajo.MoveFirst
  While Result_Trabajo.Available
    Numero_fila = GridCompras.Rows.Count
    GridCompras.Rows.Insert(Numero_fila, 1)
    GridCompras[Numero_fila, 0].Text = Result_Trabajo["C.codigocompra"]
    GridCompras[Numero_fila, 1].Text = Result_Trabajo["C.fecharecepcion"]
    GridCompras[Numero_fila, 2].Text = Result_Trabajo["C.fechafacturacompra"]
    GridCompras[Numero_fila, 3].Text = Result_Trabajo["P.razonsocial"]
    GridCompras[Numero_fila, 4].Text = Result_Trabajo["M.nombre"]
    GridCompras[Numero_fila, 5].Text = Result_Trabajo["C.cantidad"]
    GridCompras[Numero_fila, 6].Text = Result_Trabajo["C.Lotecompra"]
    GridCompras[Numero_fila, 7].Text = Result_Trabajo["C.nfacturacompra"]
    GridCompras[Numero_fila, 8].Text = Result_Trabajo["C.higiene"]
    GridCompras[Numero_fila, 9].Text = Result_Trabajo["C.carolep"]
    GridCompras[Numero_fila, 10].Text = Result_Trabajo["C.precio"]
    GridCompras[Numero_fila, 11].Text = Result_Trabajo["C.firma"]
    GridCompras[Numero_fila, 12].Text = Result_Trabajo["C.observaciones"]
    GridCompras[Numero_fila, 13].Text = Result_Trabajo["C.transporte"]
    GridCompras[Numero_fila, 14].Text = Result_Trabajo["C.stock"]
    Result_Trabajo.MoveNext
  Wend
  FMain.Conexion_Base_Datos.Close
  GridCompras.Rows.Select(Linea_Compras, 1)

End

'' Configurarmos cuando abrimos el formulario.
'' Llenamos los combobox de Proveedores y Materias Primas.
'' Si las tablas estan vacias muestra un error.

Private Sub Configurar_Objetos_Compras()
  Dim Error_Tablas_Vacias As String
  Dim Error_V As Boolean
  Error_V = False
  Linea_Compras = 0
  Uso_Filtro = False
  If Utilidades.Tabla_Vacia("select * from proveedor") = 0 Then
     Error_Tablas_Vacias = "Deber Cear Proveedores"
     Error_V = True
    Else
      CmbProveedor.Clear
      CmbFProveedor.clear
      Utilidades.Llenar_Combobox("select * from proveedor", CmbProveedor, "razonsocial")  
      CmbProveedor.text = ""
      Utilidades.Llenar_Combobox("select * from proveedor", CmbFProveedor, "razonsocial")  
      CmbFProveedor.text = ""
    Endif
  
  If Utilidades.Tabla_Vacia("select * from materiaprima") = 0 Then
   
     Error_V = True
    If Error_Tablas_Vacias = "" Then
        Error_Tablas_Vacias = "Debe Cear Materias Primas en Articulos."
      Else
        Error_Tablas_Vacias = Error_Tablas_Vacias & " y Materias Primas en Articulos."
    Endif
    Else
      CmbFMateriaPrima.Clear
      CmbMateriaPrima.Clear
      'Utilidades.Llenar_Combobox("select * from materiaprima", CmbMateriaPrima, "nombre")  
      Utilidades.Llenar_Combobox("select * from materiaprima", CmbFMateriaPrima, "nombre")  
      CmbfMateriaPrima.text = ""
  Endif
  
  If Error_V Then
    TxtlerrorCompras.Visible = True
    TxtlerrorCompras.text = Error_Tablas_Vacias
  Endif
  DteFechaRecepcion.Value = Date(Year(Now), Month(Now), Day(Now))
  DteFFacturaCompra.Value = Date(Year(Now), Month(Now), Day(Now))
  DteFFRecepcion.Value = Date(Year(Now), Month(Now), Day(Now))
  DteFIRecepcion.Value = Date(Year(Now), Month(Now), Day(Now))
  DteFFCompra.Value = Date(Year(Now), Month(Now), Day(Now))
  DteFICompra.Value = Date(Year(Now), Month(Now), Day(Now))
  TxtlerrorCompras.text = Error_Tablas_Vacias
  Configurar_Grid_Compras()
End

'' Procedimiento para borrar los campos del formulario
Private Sub Borrar_Campos_Compras()
  
  If ChkVariasCompras.Value = True Then
    TxtObservaciones.Text = ""
    TxtFirma.Text = ""
    RdbCarolepAceptable.Value = True
    RdbHigieneAceptable.Value = True
    CmbMateriaPrima.Index = -1
    VlbTransporte.text = ""
    VlbCantidad.text = ""
    VlbPrecio.text = ""
    ChkAgregarStock.Value = False
  Else
    DteFechaRecepcion.Value = Date(Year(Now), Month(Now), Day(Now))
    DteFFacturaCompra.Value = Date(Year(Now), Month(Now), Day(Now))
    TxtObservaciones.Text = ""
    TxtFirma.Text = ""
    TxtNFacturaCompra.Text = ""
    TxtNLoteCompra.Text = ""
    RdbCarolepAceptable.Value = True
    RdbHigieneAceptable.Value = True
    CmbMateriaPrima.index = -1
     CmbProveedor.index = -1
    VlbTransporte.text = ""
    VlbCantidad.text = ""
    VlbPrecio.text = ""
    ChkAgregarStock.Value = False
  Endif
  
End

'' Funcion para comprobar los Campos de Compras <br>
''  Parametros:<br>
''  Devuelve:<br>
''    TRUE --> Si los valores son correctos.<br>
''    FALSE --> valores erroneos.
Private Function Comprobar_Campos_Compras() As Boolean
  
  Dim Validar As Boolean
  Validar = True
  If TxtNFacturaCompra.Text = "" Then
   Balloon.Error("Debe introducir Nº Facatura de la Compra", TxtNFacturaCompra)
   Validar = False
   TxtNFacturaCompra.SetFocus
  Else If TxtNLoteCompra.text = ""
   Balloon.Error("Debe introducir el Nº Lote de Compra", TxtNLoteCompra)
   Validar = False
   TxtNLoteCompra.SetFocus
  Else If CmbMateriaPrima.Text = ""
    Balloon.Error("Debe elegir la Materia Prima de la compra.", CmbMateriaPrima)
    Validar = False
  Else If CmbProveedor.Text = ""
    Balloon.Error("Debe elegir un Proveedor de la compra.", CmbProveedor)
    Validar = False
  Else If VlbCantidad.Text = "0"
    Balloon.Error("Debe añadir Cantidad en Kilos de la Materia Prima de la compra.", VlbCantidad)
    Validar = False
    VlbCantidad.SetFocus
  Else If VlbPrecio.Text = "0"
    Balloon.Error("Debe elegir Precio en Euros de la  Materia Prima de la compra.", VlbPrecio)
    Validar = False
    VlbPrecio.SetFocus
  Endif
  
 Return Validar
End

'' Funcion para comprobar los Campos Varias Compras <br>
''  Parametros:<br>
''  Devuelve:<br>
''    TRUE --> Si los valores son correctos.<br>
''    FALSE --> valores erroneos.
Private Function Comprobar_Campos_Varias_Compras() As Boolean
  
  Dim Validar As Boolean
  Validar = True
  If TxtNFacturaCompra.Text = "" Then
   Balloon.Error("Debe introducir Nº Facatura de la Compra", TxtNFacturaCompra)
   Validar = False
   TxtNFacturaCompra.SetFocus
  Else If TxtNLoteCompra.text = ""
   Balloon.Error("Debe introducir el Nº Lote de Compra", TxtNLoteCompra)
   Validar = False
   TxtNLoteCompra.SetFocus
  Else If CmbProveedor.Text = ""
    Balloon.Error("Debe elegir un Proveedor de la compra.", CmbProveedor)
    Validar = False
   Endif
  
 Return Validar
End








